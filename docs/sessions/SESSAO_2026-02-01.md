# üìã SESS√ÉO 2026-02-01 - Deploy + Bugs Pendentes

## ‚úÖ O QUE FOI FEITO HOJE

### 1. Corre√ß√µes de Login/Autentica√ß√£o
- Criado `/api/admin/verify-user/route.ts` para verificar usu√°rios (bypass RLS com service key)
- Criado `/api/stripe/verify-session/route.ts` para fallback de ativa√ß√£o de assinaturas
- Corrigido bot√£o "Login As" no painel admin (removido confirm() bloqueado)

### 2. Corre√ß√£o de Planos
- Corrigido `/api/profile/me/route.ts` para buscar dados de `plan_config` pelo tier
- Investigado problema de FK antiga apontando para `plan_tiers_old`

### 3. Crop de Imagem (Pr√™mios)
- Refeito componente `/components/admin/ImageCropDialog.tsx` usando `react-easy-crop`
- Instalado pacote `react-easy-crop`
- Integrado bot√£o "Remover Fundo (IA)" dentro do dialog de crop
- Criada documenta√ß√£o em `/docs/components/IMAGE_CROP_COMPONENTS.md`

### 4. Deploy
- Deploy enviado com sucesso para Vercel
- Tag de backup criada: `v1.0.0-pre-deploy-2026-02-01`

---

## üêõ BUGS PENDENTES (URGENTES)

### Bug 1: Status "PENDENTE" ap√≥s confirmar email
**Descri√ß√£o:** Usu√°rio confirmou email mas continua como "Pendente" no painel admin
**Local:** `/app/admin/users/page.tsx` e l√≥gica de atualiza√ß√£o de status
**Causa prov√°vel:** O campo `email_confirmed_at` do auth.users n√£o est√° sendo sincronizado com a tabela profiles
**Solu√ß√£o sugerida:** 
- Verificar trigger `on_auth_user_created` 
- Ou criar trigger `on_auth_user_updated` para atualizar status quando email √© confirmado

### Bug 2: Plano mostra "RECRUTA" no dashboard do usu√°rio
**Descri√ß√£o:** No admin mostra "Elite" corretamente, mas no perfil do usu√°rio mostra "RECRUTA"
**Local:** `/api/profile/me/route.ts` ou componente que exibe o plano
**Causa prov√°vel:** A query `plan_config` est√° buscando pelo `tier` mas o campo `plan_id` na subscriptions pode estar com valor diferente
**Investigar:**
- Verificar valor de `subscription.plan_id` no banco
- Comparar com os valores em `plan_config`
- Pode ser que `plan_id` seja UUID e estamos buscando por `tier` (string)

### Bug 3: Perfil do usu√°rio vem VAZIO ap√≥s cadastro
**Descri√ß√£o:** Os dados preenchidos no formul√°rio de registro (nome, cidade, etc) n√£o est√£o sendo salvos no perfil
**Local:** Trigger `on_auth_user_created` no Supabase ou `/app/auth/callback/route.ts`
**Campos afetados:**
- ID Rota (n√£o gerado)
- Pista/Localiza√ß√£o (n√£o salva)
- Dados do formul√°rio de registro n√£o aparecem
**Causa prov√°vel:** O trigger `handle_new_user` n√£o est√° extraindo os metadata do auth.users corretamente
**Solu√ß√£o sugerida:**
- Verificar se os campos est√£o sendo passados via `user_metadata` no signup
- Verificar trigger SQL que cria o profile

### Bug 4: Limite de categorias mostra "3" (incorreto)
**Descri√ß√£o:** Mostra "0/3 categorias" mas os planos s√≥ permitem 2 ou 4 categorias
**Local:** P√°gina de editar perfil ou componente de categorias
**Causa prov√°vel:** Est√° usando valor hardcoded "3" em vez de puxar do plan_config
**Solu√ß√£o:** Buscar `max_categories` do plano do usu√°rio em `plan_config`

### Bug 5: Hist√≥rico de Batalha vazio (mas pontos aparecem)
**Descri√ß√£o:** Usu√°rio tem 300 pts e aparece #3 no ranking, mas o hist√≥rico mostra "Nenhuma atividade registrada"
**Local:** Componente de hist√≥rico de batalha ou query de `xp_history`
**Causa prov√°vel:** A atividade que gerou os pontos n√£o foi registrada na tabela `xp_history`, apenas incrementou o XP
**Solu√ß√£o:** Verificar se as a√ß√µes que d√£o XP est√£o criando registro em `xp_history`

---

## üìù TAREFAS PARA PR√ìXIMA SESS√ÉO

### URGENTES (Antes de mais deploys)
- [ ] **Corrigir Bug 1:** Status pendente ap√≥s confirmar email
- [ ] **Corrigir Bug 2:** Plano incorreto no dashboard do usu√°rio
- [ ] **Corrigir Bug 3:** Dados do cadastro n√£o salvando no perfil (ID Rota, Pista, etc)
- [ ] **Reativar valida√ß√£o de ID Rota √∫nico** (estava desativada para testes)

### MELHORIAS
- [ ] Implementar AlertDialog para confirma√ß√£o de "Login As" (substituir confirm nativo)
- [ ] Testar fluxo completo de compra de plano em produ√ß√£o
- [ ] Verificar se emails de transa√ß√£o est√£o sendo enviados

---

## üîß ARQUIVOS MODIFICADOS HOJE

```
app/api/admin/verify-user/route.ts (NOVO)
app/api/stripe/verify-session/route.ts (NOVO)
app/api/profile/me/route.ts (MODIFICADO)
app/admin/users/page.tsx (MODIFICADO)
components/admin/ImageCropDialog.tsx (REFEITO com react-easy-crop)
docs/components/IMAGE_CROP_COMPONENTS.md (NOVO)
docs/MODO_TESTE_REGISTRO.md (NOVO)
```

---

## üõ°Ô∏è BACKUP E RECUPERA√á√ÉO

**Tag de recupera√ß√£o segura:**
```bash
git checkout v1.0.0-pre-deploy-2026-02-01
```

**Commit atual:**
```
3297383f - BACKUP PRE-DEPLOY: Login, Planos, Usu√°rios funcionando - 2026-02-01 15:23
```

---

## üìö CONTEXTO T√âCNICO

### Tabelas envolvidas nos bugs:
- `profiles` - dados do usu√°rio (status de verifica√ß√£o)
- `subscriptions` - assinaturas (plan_id)
- `plan_config` - configura√ß√£o dos planos (tier, features)
- `auth.users` - usu√°rios do Supabase Auth (email_confirmed_at)

### APIs cr√≠ticas (N√ÉO MEXER SEM NECESSIDADE):
- `/api/auth/*` - autentica√ß√£o
- `/api/profile/me` - dados do perfil
- `/api/stripe/*` - pagamentos

---

## ‚ö†Ô∏è AVISOS IMPORTANTES

1. **N√ÉO ALTERAR** sistema de login sem testar localmente primeiro
2. **SEMPRE** criar backup antes de altera√ß√µes em auth/subscriptions
3. **CONFIRMAR** que RLS policies est√£o corretas ap√≥s qualquer altera√ß√£o
4. A valida√ß√£o de **ID Rota √∫nico** est√° DESATIVADA - reativar ap√≥s testes

---

## üë• EQUIPE

- **Carlos** (`/carlos-backend`) - Backend
- **Marina** (`/marina-frontend`) - Frontend  
- **Lucas** (`/lucas-ux`) - UI/UX
- **Rafael** (`/rafael-dba`) - Banco de Dados
- **Antigravity** - Coordena√ß√£o

---

*√öltima atualiza√ß√£o: 2026-02-01 15:31*
